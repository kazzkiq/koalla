#!/usr/bin/env node

const sade = require("sade");
const { exec, execSync } = require("child_process");
const fs = require("fs");

const prog = sade("koalla");
const { version } = require("../package.json");
const { red, cyan, white } = require("console-log-colors");

prog.version(version);

prog
  .command("init <directory>")
  .describe(
    "Scaffold a new project in the given directory. The directory must be ideally empty."
  )
  .option(
    "-o, --overwrite",
    "Koalla overwrites any files that already exist in the directory. Be aware."
  )
  .example("init ./my-project")
  .action((directory, opts) => {
    try {
      execSync(`mkdir -p ${directory}`);
    } catch (e) {
      console.log(
        `Koalla: ${red(` could not create the directory ${directory}.`)}`
      );
      console.log(e);
      return;
    }

    console.log("");
    console.log(`  Koalla: ${cyan("Creating project...")}`);

    let degitCommand = `npx -y degit github:kazzkiq/koalla`;

    if (opts.o) {
      degitCommand = `npx -y degit github:kazzkiq/koalla --force`;
    }

    exec(`cd ${directory} && ${degitCommand}`, (err, stdout, stderr) => {
      if (err) {
        if (err.message.includes("directory is not empty")) {
          console.log(
            `  Koalla: ${red(
              `The directory you're trying to use (${white(
                directory
              )}) already exists and is not empty.
          Check your directory or use ${cyan("--overwrite")}`
            )}`
          );
          console.log("");
        } else {
          console.error(`Error: ${err}`);
        }

        return;
      }

      if (
        stdout.includes("cloned kazzkiq/koalla") ||
        stderr.includes("cloned kazzkiq/koalla")
      ) {
        console.log(`  Koalla: ${cyan("Success! üåø")}`);
        console.log(cyan(""));
        console.log("  Next steps:");
        console.log(cyan(`  cd ${directory}`));
        console.log(cyan(`  npm i`));
        console.log(cyan(`  npm run dev`));
        console.log("");
        console.log(`  Open in browser: http://localhost:4000`);
        console.log(cyan(``));
        console.log(`  And that's it! Time to rock your API! üê®`);
        console.log(cyan(``));
        console.log(`  If you need help for creating routes simply run:`);
        console.log(cyan(`  npx koalla gen --help`));
        console.log("");
        console.log("");
      }
    });
  });

prog
  .command("new <action> <name>")
  .describe("Create a new route, or lib.")
  .option(
    "-o, --overwrite",
    "Koalla overwrites any files that already exist in the directory. Be aware."
  )
  .example("new route user-orders")
  .example("new lib color-shuffle")
  .action((action, name, opts) => {
    if (!["route", "lib"].includes(action)) {
      console.log(
        `  Koalla: ${red(
          `You must use either ${white("route")} or ${white(
            "lib"
          )} as the first command.`
        )}`
      );
      console.log("");
      return;
    }

    if (!name.match(/^[a-z]+[a-z-]+[a-z]+$/)) {
      console.log(
        `  Koalla: ${red(
          `Your file must use only ${white(
            "lower-case letters [a-z]"
          )} and ${white("dashes (-)")}.`
        )}`
      );
      console.log("");
      return;
    }

    const directoryToLook = (() => {
      if (action === "route") {
        return "endpoints";
      } else if (action === "lib") {
        return "commons";
      }
    })();

    if (fs.existsSync(`./${directoryToLook}/${name}.ts`)) {
      console.log(
        `  Koalla: ${red(
          `The file ${white(
            `${name}`.ts
          )} already exists. Choose a different name.`
        )}`
      );
      return;
    }

    const exists = fs.read;
    console.log(action, name, opts);
  });

prog.parse(process.argv);
